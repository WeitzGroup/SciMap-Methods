"0","term_tab_orig <- read.csv(""data/nih_terminations_airtable - JAMA.csv"") %>%"
"0","  mutate(award_remaining = as.numeric(str_replace(total_estimated_remaining, ""\\$"", """"))) %>%"
"0","  mutate(org_name = toupper(org_name)) %>%"
"0","  mutate(award_remaining_noself = ifelse(cancellation_source == ""Self reported"", 0 , award_remaining)) %>%"
"0","  # exclude reinstated grants"
"0","  filter(is.na(reinstated_est_date)) %>%"
"0","    mutate(award_remaining = ifelse(award_remaining <0 , 0 , award_remaining),"
"0","           award_remaining_noself = ifelse(award_remaining_noself <0 , 0 , award_remaining_noself)) "
"0",""
"0","# combine subinstitutions"
"0","repeated_dict <- read.csv(""term_data/repeated_orgs.csv"") "
"0",""
"0","# identify whether there are any additional repeated orgs (if so, will need to review them at line 179)"
"0","new_org_names <- setdiff(term_tab_orig$org_name, repeated_dict$org_name)"
"0",""
"0","term_tab <- repeated_dict %>%"
"0","  right_join(term_tab_orig) %>%"
"0","  mutate(org_name = ifelse(fix_name=="""" | is.na(fix_name), org_name, fix_name))"
"2","Joining with `by = join_by(org_name)`"
"0","# patch bc university of colorado schools are all called the same thing"
"0","unique(term_tab$org_congdist[term_tab$org_name == ""UNIVERSITY OF COLORADO""])"
"1","[1]"
"1"," ""CO-02"""
"1","
"
"0","term_tab$org_name[term_tab$org_name==""UNIVERSITY OF COLORADO"" & term_tab$org_city == ""Boulder""] <- ""UNIVERSITY OF COLORADO - COLORADO SPRINGS"""
"0","#term_tab$org_name[term_tab$org_name==""HARVARD UNIVERSITY D/B/A HARVARD SCHOOL OF PUBLIC HEALTH""] <- ""HARVARD SCHOOL OF PUBLIC HEALTH"""
"0",""
"0","# use FY2024 grants to geolocate terminated grants (by matching to org name)"
"0","loc_tab <- NIH_clean_fips %>%"
"0","  mutate(FIPS = str_pad(FIPS, 5, pad = ""0"")) %>%"
"0","  mutate(org_name = toupper(org_name)) %>%"
"0","  mutate(lat = as.numeric(lat),"
"0","         lon = as.numeric(lon)) %>%"
"0","  select(org_name, lat, lon, FIPS) %>%"
"0","  distinct() %>%"
"0","  filter(!is.na(org_name))"
"0",""
"0","loc_tab <-read.csv(""./data/geoid_dictionary_July4.csv"") %>%"
"0","            select(-GEOID) %>%"
"0","            mutate(GEOID = str_pad(New119Fips, 4, pad = ""0"")) %>%"
"0","            select(lat, lon, GEOID) %>%"
"0","            distinct() %>%"
"0","            left_join(loc_tab) %>%"
"0","            select(org_name, lat, lon, GEOID, FIPS) %>%"
"0","            filter(!is.na(org_name))"
"2","Joining with `by = join_by(lat, lon)`"
"0","loc_tab$org_name[loc_tab$org_name==""UNIVERSITY OF COLORADO"" & loc_tab$GEOID == ""0805""] <- ""UNIVERSITY OF COLORADO - COLORADO SPRINGS"""
"0","loc_tab$org_name[loc_tab$org_name==""UNIVERSITY OF COLORADO"" & loc_tab$GEOID == ""0802""] <- ""UNIVERSITY OF COLORADO BOULDER"""
"0",""
"0","# find termination grants that aren't in the location table"
"0","# (org didn't receive funds in FY2024)"
"0","canada_prov <- c(""AB"", ""BC"", ""MB"", ""NB"", ""NL"", ""NS"", ""ON"", ""PE"", ""QC"", ""SK"", ""NT"", ""NU"", ""YT"")"
"0",""
"0","term_tab %>%"
"0","  filter(!org_name %in% loc_tab$org_name) %>%"
"0","  # remove grants from Canada, territories"
"0","  filter(! is.na(org_state) & ! org_state %in% canada_prov & org_state != ""PR"" & org_state != ""VI"") %>%"
"0","  select(org_name) %>% unique() -> missing_loc"
"0",""
"0","# find the lat/lon for these orgs based on prior year funding"
"0","missing_coords <- read.csv(""data/NIH_prior.csv"") %>%"
"0","  mutate(org_name = toupper(Organization.Name)) %>%"
"0","  select(org_name, Longitude, Latitude) %>%"
"0","  rename(lon = Longitude,"
"0","         lat = Latitude) %>%"
"0","  distinct() %>%"
"0","  filter(!is.na(org_name)) %>%"
"0","  filter(org_name %in% missing_loc$org_name)"
"0",""
"0","# if there are more organizations added with missing coords, will need to relocate"
"0","# using API call: https://geo.fcc.gov/api/census/block/find?latitude=lat&longitude=long&showall=true&format=json"
"0","print(missing_coords)"
